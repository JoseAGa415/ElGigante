{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Procesado - Lote {{ lote.codigo }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Encabezado -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                <i class="fas fa-cogs text-amber-600"></i>
                Crear Nuevo Procesado/Trilla
            </h1>
            <p class="mt-2 text-gray-600">
                Registrar proceso de trilla de café del lote <strong class="text-amber-700">{{ lote.codigo }}</strong>
            </p>
        </div>

        <!-- Información del Lote -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-600"></i>
                Información del Lote
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Código</p>
                    <p class="text-lg font-bold text-gray-900">{{ lote.codigo }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Tipo</p>
                    <p class="text-lg font-bold text-gray-900">{{ lote.tipo_cafe }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Bodega</p>
                    <p class="text-lg font-bold text-gray-900">{{ lote.bodega.codigo }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Peso Total</p>
                    <p class="text-lg font-bold text-gray-900">{{ lote.peso_kg }} kg</p>
                    <p class="text-xs text-gray-500">{{ lote.peso_en_quintales|floatformat:2 }} qq</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border-2 border-green-500">
                    <p class="text-xs text-green-600 uppercase font-semibold mb-1">Disponible</p>
                    <p class="text-2xl font-bold text-green-700">{{ lote.peso_disponible|floatformat:2 }}</p>
                    <p class="text-xs text-green-600">kg ({{ lote.peso_disponible_qq|floatformat:2 }} qq)</p>
                    {% if lote.peso_procesado > 0 %}
                        <p class="text-xs text-gray-500 mt-1">Ya procesado: {{ lote.porcentaje_procesado|floatformat:0 }}%</p>
                    {% endif %}
                </div>
            </div>
        </div>
         <!-- SECCIÓN: INFORMACIÓN DEL PERSONAL -->
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-lg border-2 border-purple-300">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                <i class="fas fa-users text-purple-600"></i>
                Información del Personal
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user-tie text-blue-600 mr-1"></i>
                        Persona Encargada <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           name="encargado_mezcla"
                           required
                           placeholder="Nombre del encargado"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 font-semibold">
                    <p class="text-xs text-gray-500 mt-1">Persona responsable de la mezcla</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-users text-green-600 mr-1"></i>
                        Cantidad de Personal <span class="text-red-500">*</span>
                    </label>
                    <input type="number" 
                           name="personas_trabajando"
                           min="1"
                           required
                           placeholder="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 font-semibold text-lg">
                    <p class="text-xs text-gray-500 mt-1">Número de personas que trabajaron ese día</p>
                </div>
            </div>
        </div>
        <!-- Formulario -->
        <form method="post" class="bg-white rounded-xl shadow-lg p-8 space-y-8">
            {% csrf_token %}

            <!-- Alerta informativa -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                <div class="flex">
                    <i class="fas fa-info-circle text-blue-600 text-xl mr-3"></i>
                    <div>
                        <p class="text-sm text-blue-800">
                            El número de trilla se generará automáticamente (Ej: T-0001, T-0002, etc.)
                        </p>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: HORARIO DEL PROCESO -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-2 border-blue-300">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-clock text-blue-600"></i>
                    Horario del Proceso
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Fecha de Procesado <span class="text-red-500">*</span>
                        </label>
                        <input type="date" 
                               name="fecha_procesado"
                               value="{{ today|date:'Y-m-d' }}"
                               required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600">
                        <p class="text-xs text-gray-500 mt-1">Fecha del proceso de trilla</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Hora de Inicio <span class="text-red-500">*</span>
                        </label>
                        <input type="time" 
                               name="hora_inicio"
                               required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600">
                        <p class="text-xs text-gray-500 mt-1">Hora en que inició el procesamiento</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Hora Final <span class="text-red-500">*</span>
                        </label>
                        <input type="time" 
                               name="hora_final"
                               required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600">
                        <p class="text-xs text-gray-500 mt-1">Hora en que finalizó el procesamiento</p>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: BODEGA DE ALMACENAMIENTO -->
            <div class="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-warehouse text-amber-600"></i>
                    Bodega de Almacenamiento
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ¿En qué bodega quedó el café? <span class="text-red-500">*</span>
                        </label>
                        <select name="bodega_destino"
                                required
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-amber-600">
                            <option value="">Seleccione bodega...</option>
                            {% for bodega in bodegas %}
                            <option value="{{ bodega.id }}" {% if bodega.id == lote.bodega.id %}selected{% endif %}>
                                Bodega {{ bodega.codigo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-xs text-blue-600 font-semibold mb-1">BODEGA ORIGINAL</p>
                        <p class="text-xl font-bold text-gray-900">Bodega {{ lote.bodega.codigo }}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-bars mr-1 text-amber-600"></i>
                            Percha (Opcional)
                        </label>
                        <input type="text"
                               name="percha"
                               placeholder="Ej: Percha A, Estante 1"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-amber-600">
                        <p class="text-xs text-gray-500 mt-1">Nombre o código de la percha</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-layer-group mr-1 text-amber-600"></i>
                            Fila (Opcional)
                        </label>
                        <input type="text"
                               name="fila"
                               placeholder="Ej: Fila 1, Nivel 2"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-amber-600">
                        <p class="text-xs text-gray-500 mt-1">Fila en la percha</p>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: PESO DE REFERENCIA PARA SACOS -->
            <div class="bg-purple-50 border-l-4 border-purple-500 p-6 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-box text-purple-600"></i>
                    Peso de Referencia para Sacos
                </h2>
                <p class="text-sm text-gray-600 mb-4">
                    Define el peso estándar de tus sacos para calcular automáticamente cuántos sacos obtendrás
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Peso del Saco <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" 
                                   step="0.01"
                                   name="peso_saco_referencia"
                                   value="69"
                                   required
                                   placeholder="69"
                                   class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-600 font-semibold text-lg">
                            <select name="unidad_saco_referencia" 
                                    class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-600 bg-white font-semibold">
                                <option value="kg" selected>kg</option>
                                <option value="lb">lb</option>
                            </select>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Peso estándar de cada saco (ej: 69 kg, 152 lb)</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                        <p class="text-xs text-purple-600 font-semibold uppercase mb-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Ejemplos Comunes
                        </p>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>• <strong>69 kg</strong> - Sacos estándar</li>
                            <li>• <strong>152 lb</strong> - Sacos de 152 libras</li>
                            <li>• <strong>46 kg</strong> - Quintales</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: PESOS DEL PROCESADO -->
            <div class="border-l-4 border-blue-500 bg-blue-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-balance-scale text-blue-600"></i>
                    Pesos del Procesado
                </h2>
                
                <!-- Peso Inicial -->
                <div class="mb-6">
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-arrow-down text-green-600 mr-2"></i>
                        Peso Inicial <span class="text-red-500 ml-1">*</span>
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   name="operacion_peso_inicial"
                                   placeholder="Ej: 13*1.52+0.58"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado</label>
                            <input type="number" 
                                   step="0.01"
                                   name="peso_inicial_kg"
                                   required
                                   placeholder="0.00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 font-semibold">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_peso_inicial" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 bg-white font-semibold text-center">
                                <option value="kg" selected>kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">lb</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Peso del café antes de procesar</p>
                </div>

                <!-- Peso Final -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-arrow-up text-blue-600 mr-2"></i>
                        Peso Final <span class="text-red-500 ml-1">*</span>
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   name="operacion_peso_final"
                                   placeholder="Ej: 8*1.52"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado</label>
                            <input type="number" 
                                   step="0.01"
                                   name="peso_final_kg"
                                   required
                                   placeholder="0.00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 font-semibold">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_peso_final" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 bg-white font-semibold text-center">
                                <option value="kg" selected>kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">lb</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Peso del café después de procesar</p>
                </div>

                <!-- Rendimiento Calculado -->
                <div class="mt-6 bg-white p-4 rounded-lg border-2 border-blue-300">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">
                            <i class="fas fa-percent text-blue-600 mr-2"></i>
                            Rendimiento Calculado:
                        </span>
                        <span class="text-2xl font-bold text-blue-600" id="rendimiento">0.00%</span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: CLASIFICACIÓN DEL CAFÉ -->
            <div class="border-l-4 border-yellow-500 bg-yellow-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-600"></i>
                    Clasificación del Café
                </h2>
                
                <!-- Café de Primera -->
                <div class="mb-4">
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-trophy text-yellow-600 mr-2"></i>
                        Café de Primera
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   name="operacion_cafe_primera"
                                   placeholder="Ej: 8*1.52"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado</label>
                            <input type="number" 
                                   step="0.01"
                                   name="cafe_primera"
                                   value="0"
                                   placeholder="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600 font-semibold">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_cafe_primera" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600 bg-white font-semibold text-center">
                                <option value="kg" selected>kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">lb</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Café de Segunda -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-medal text-gray-500 mr-2"></i>
                        Café de Segunda
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   name="operacion_cafe_segunda"
                                   placeholder="Ej: 2*1.52"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado</label>
                            <input type="number" 
                                   step="0.01"
                                   name="cafe_segunda"
                                   value="0"
                                   placeholder="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600 font-semibold">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_cafe_segunda" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600 bg-white font-semibold text-center">
                                <option value="kg" selected>kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">lb</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <script>
// ========================================
// CALCULADORA DE OPERACIONES MATEMÁTICAS
// ========================================

function evaluarOperacion(inputOperacion, inputResultado) {
    const operacion = inputOperacion.value.trim();
    
    if (!operacion) return;
    
    try {
        // Reemplazar x y X por *
        const operacionLimpia = operacion.replace(/x|X/g, '*');
        
        // Evaluar la operación
        const resultado = eval(operacionLimpia);
        
        if (!isNaN(resultado) && isFinite(resultado)) {
            inputResultado.value = resultado.toFixed(2);
            
            // Disparar evento para recalcular rendimiento
            inputResultado.dispatchEvent(new Event('input'));
        }
    } catch (error) {
        console.error('Error en operación:', error);
        alert('⚠️ Operación inválida. Usa formato: 13*1.52+0.58');
    }
}

// Configurar calculadoras para todos los campos
const calculadoras = [
    { operacion: 'operacion_peso_inicial', resultado: 'peso_inicial_kg' },
    { operacion: 'operacion_peso_final', resultado: 'peso_final_kg' },
    { operacion: 'operacion_cafe_primera', resultado: 'cafe_primera' },
    { operacion: 'operacion_cafe_segunda', resultado: 'cafe_segunda' }
];

calculadoras.forEach(calc => {
    const inputOp = document.querySelector(`input[name="${calc.operacion}"]`);
    const inputRes = document.querySelector(`input[name="${calc.resultado}"]`);
    
    if (inputOp && inputRes) {
        // Calcular al perder el foco
        inputOp.addEventListener('blur', () => evaluarOperacion(inputOp, inputRes));
        
        // Calcular al presionar Enter
        inputOp.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                evaluarOperacion(inputOp, inputRes);
            }
        });
    }
});

          </script>  
            <!-- SECCIÓN: MERMAS Y RECHAZOS -->
            <div class="border-l-4 border-red-500 bg-red-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                    Mermas del Procesado
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catadura (kg)</label>
                        <input type="number" step="0.01" name="catadura" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Rechazo Electrónica (kg)</label>
                        <input type="number" step="0.01" name="rechazo_electronica" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bajo Zaranda (kg)</label>
                        <input type="number" step="0.01" name="bajo_zaranda" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Barridos (kg)</label>
                        <input type="number" step="0.01" name="barridos" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: OBSERVACIONES -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-comment-alt text-gray-600 mr-2"></i>
                    Observaciones
                </label>
                <textarea name="observaciones" 
                          rows="4"
                          placeholder="Notas adicionales sobre el procesado..."
                          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600"></textarea>
            </div>

            <!-- Botones -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <a href="{% url 'seleccionar_lote_procesar' %}" 
                   class="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">
                    <i class="fas fa-times mr-2"></i>
                    Cancelar
                </a>
                <button type="submit" 
                        class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition font-medium shadow-lg hover:shadow-xl">
                    <i class="fas fa-save mr-2"></i>
                    Registrar Procesado
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Peso máximo disponible del lote
const pesoMaximoDisponible = {{ lote.peso_disponible }};

// Validación de peso máximo
function validarPesoMaximo() {
    const pesoAProcesar = parseFloat(document.querySelector('input[name="peso_inicial_kg"]').value) || 0;
    
    if (pesoAProcesar > pesoMaximoDisponible) {
        alert(`❌ ERROR: No puedes procesar ${pesoAProcesar.toFixed(2)} kg.\n\nSolo hay ${pesoMaximoDisponible.toFixed(2)} kg disponibles en el lote.\n\nPeso ya procesado: {{ lote.peso_procesado|floatformat:2 }} kg de {{ lote.peso_kg }} kg totales.`);
        document.querySelector('input[name="peso_inicial_kg"]').value = pesoMaximoDisponible.toFixed(2);
        return false;
    }
    return true;
}

// Calcular rendimiento en tiempo real
function calcularRendimiento() {
    const pesoInicial = parseFloat(document.querySelector('input[name="peso_inicial_kg"]').value) || 0;
    const pesoFinal = parseFloat(document.querySelector('input[name="peso_final_kg"]').value) || 0;
    
    if (pesoInicial > 0) {
        const rendimiento = (pesoFinal / pesoInicial) * 100;
        document.getElementById('rendimiento').textContent = rendimiento.toFixed(2) + '%';
    } else {
        document.getElementById('rendimiento').textContent = '0.00%';
    }
}

// Listeners para calcular rendimiento
document.querySelector('input[name="peso_inicial_kg"]').addEventListener('input', calcularRendimiento);
document.querySelector('input[name="peso_final_kg"]').addEventListener('input', calcularRendimiento);

// Validar al perder el foco del campo
document.querySelector('input[name="peso_inicial_kg"]').addEventListener('blur', validarPesoMaximo);

// Validación de horas y peso en el submit
document.querySelector('form').addEventListener('submit', function(e) {
    const horaInicio = document.querySelector('input[name="hora_inicio"]').value;
    const horaFinal = document.querySelector('input[name="hora_final"]').value;
    
    // Validar horas
    if (horaInicio && horaFinal && horaFinal < horaInicio) {
        e.preventDefault();
        alert('⚠️ La hora final no puede ser menor que la hora de inicio.');
        return false;
    }
    
    // Validar peso máximo
    if (!validarPesoMaximo()) {
        e.preventDefault();
        return false;
    }
});

// Auto-completar hora actual
window.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const horaActual = now.toTimeString().slice(0, 5);
    
    const inputHoraInicio = document.querySelector('input[name="hora_inicio"]');
    if (inputHoraInicio && !inputHoraInicio.value) {
        inputHoraInicio.value = horaActual;
    }
});
</script>
{% endblock %}