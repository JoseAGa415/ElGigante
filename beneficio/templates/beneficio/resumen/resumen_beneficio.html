{% extends 'base.html' %}
{% load static %}

{% block title %}Resumen del Beneficio - INPROCAF{% endblock %}

{% block extra_css %}
<style>
    /* Variables de color personalizadas */
    :root {
        --coffee-primary: #8B4513;
        --coffee-dark: #5D2E0F;
        --coffee-light: #D2691E;
    }

    /* Contenedor principal */
    .dashboard-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 2rem 1rem;
    }

    /* Cards mejorados */
    .stat-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        opacity: 0.1;
        transform: translate(30%, -30%);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .stat-card.green { border-left-color: #10B981; }
    .stat-card.green::before { background: #10B981; }
    
    .stat-card.purple { border-left-color: #8B5CF6; }
    .stat-card.purple::before { background: #8B5CF6; }
    
    .stat-card.indigo { border-left-color: #6366F1; }
    .stat-card.indigo::before { background: #6366F1; }
    
    .stat-card.amber { border-left-color: #F59E0B; }
    .stat-card.amber::before { background: #F59E0B; }

    /* Iconos de estadísticas */
    .stat-icon {
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }

    /* Gráficos */
    .chart-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        height: 100%;
    }

    .chart-wrapper {
        position: relative;
        height: 350px;
        margin-top: 1rem;
    }

    /* Tabs mejorados */
    .tab-button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

    .tab-button.active {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Tabla mejorada */
    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .data-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .data-table thead th:first-child {
        border-top-left-radius: 0.5rem;
    }

    .data-table thead th:last-child {
        border-top-right-radius: 0.5rem;
    }

    .data-table tbody tr {
        transition: all 0.2s;
        background: white;
    }

    .data-table tbody tr:hover {
        background: #f9fafb;
        transform: scale(1.01);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .data-table tbody td {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    /* Badge mejorado */
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Animaciones */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chart-wrapper {
            height: 250px;
        }
        
        .stat-card {
            padding: 1rem;
        }
        
        .data-table {
            font-size: 0.875rem;
        }
    }

    /* Scrollbar personalizado */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Header gradient */
    .hero-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container" x-data="dashboardBeneficio()">
    
    <!-- Header Hero -->
    <div class="hero-gradient rounded-2xl shadow-2xl p-6 md:p-8 mb-6 text-white animate-fade-in">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
                <!-- Title Section -->
                <div class="flex-1">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="bg-white/20 backdrop-blur-sm p-4 rounded-xl">
                            <i class="fas fa-chart-line text-4xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl md:text-4xl font-bold">Resumen del Beneficio</h1>
                            <p class="text-white/90 mt-1 text-sm md:text-base">
                                Análisis completo de operaciones y calidad
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <span class="bg-white/20 backdrop-blur-sm px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span x-text="periodoActual"></span>
                        </span>
                        <span class="bg-white/20 backdrop-blur-sm px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-clock mr-2"></i>
                            Últimos 30 días
                        </span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button @click="imprimirReporte()" 
                            class="bg-white/20 backdrop-blur-sm text-white px-6 py-3 rounded-lg hover:bg-white/30 font-semibold transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-print"></i>
                        <span>Imprimir</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="max-w-7xl mx-auto mb-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <!-- Total Procesado -->
            <div class="stat-card green animate-fade-in" style="animation-delay: 0.1s;">
                <div class="flex items-start justify-between relative z-10">
                    <div class="flex-1">
                        <p class="text-gray-600 text-sm font-semibold uppercase mb-2">Total Procesado</p>
                        <h3 class="text-3xl md:text-4xl font-bold text-gray-900 mb-1">
                            {{ stats.total_procesado|floatformat:0 }}
                            <span class="text-lg text-gray-600">kg</span>
                        </h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-green-600 font-semibold text-sm flex items-center">
                                <i class="fas fa-arrow-up mr-1"></i>
                                {{ stats.variacion_procesado|floatformat:1 }}%
                            </span>
                            <span class="text-gray-500 text-xs">vs mes anterior</span>
                        </div>
                    </div>
                    <div class="stat-icon bg-green-100">
                        <i class="fas fa-cogs text-green-600"></i>
                    </div>
                </div>
            </div>

            <!-- Total Reprocesado -->
            <div class="stat-card purple animate-fade-in" style="animation-delay: 0.2s;">
                <div class="flex items-start justify-between relative z-10">
                    <div class="flex-1">
                        <p class="text-gray-600 text-sm font-semibold uppercase mb-2">Total Reprocesado</p>
                        <h3 class="text-3xl md:text-4xl font-bold text-gray-900 mb-1">
                            {{ stats.total_reproceso|floatformat:0 }}
                            <span class="text-lg text-gray-600">kg</span>
                        </h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-red-600 font-semibold text-sm flex items-center">
                                <i class="fas fa-arrow-down mr-1"></i>
                                {{ stats.variacion_reproceso|floatformat:1 }}%
                            </span>
                            <span class="text-gray-500 text-xs">vs mes anterior</span>
                        </div>
                    </div>
                    <div class="stat-icon bg-purple-100">
                        <i class="fas fa-sync text-purple-600"></i>
                    </div>
                </div>
            </div>

            <!-- Total Mezclas -->
            <div class="stat-card indigo animate-fade-in" style="animation-delay: 0.3s;">
                <div class="flex items-start justify-between relative z-10">
                    <div class="flex-1">
                        <p class="text-gray-600 text-sm font-semibold uppercase mb-2">Total Mezclas</p>
                        <h3 class="text-3xl md:text-4xl font-bold text-gray-900 mb-1">
                            {{ stats.total_mezclas|floatformat:0 }}
                            <span class="text-lg text-gray-600">kg</span>
                        </h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-green-600 font-semibold text-sm flex items-center">
                                <i class="fas fa-arrow-up mr-1"></i>
                                {{ stats.variacion_mezclas|floatformat:1 }}%
                            </span>
                            <span class="text-gray-500 text-xs">vs mes anterior</span>
                        </div>
                    </div>
                    <div class="stat-icon bg-indigo-100">
                        <i class="fas fa-blender text-indigo-600"></i>
                    </div>
                </div>
            </div>

            <!-- Rendimiento Promedio -->
            <div class="stat-card amber animate-fade-in" style="animation-delay: 0.4s;">
                <div class="flex items-start justify-between relative z-10">
                    <div class="flex-1">
                        <p class="text-gray-600 text-sm font-semibold uppercase mb-2">Rendimiento</p>
                        <h3 class="text-3xl md:text-4xl font-bold text-gray-900 mb-1">
                            {{ stats.rendimiento_promedio|floatformat:1 }}
                            <span class="text-lg text-gray-600">%</span>
                        </h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-green-600 font-semibold text-sm flex items-center">
                                <i class="fas fa-check-circle mr-1"></i>
                                Objetivo: 82%
                            </span>
                        </div>
                    </div>
                    <div class="stat-icon bg-amber-100">
                        <i class="fas fa-percentage text-amber-600"></i>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto mb-6">
        <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex flex-wrap gap-3">
                <button @click="activeTab = 'procesados'" 
                        :class="activeTab === 'procesados' ? 'bg-green-600 text-white active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="tab-button flex items-center gap-2">
                    <i class="fas fa-cogs"></i>
                    <span class="hidden sm:inline">Procesados</span>
                </button>
                
                <button @click="activeTab = 'reprocesos'" 
                        :class="activeTab === 'reprocesos' ? 'bg-purple-600 text-white active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="tab-button flex items-center gap-2">
                    <i class="fas fa-sync"></i>
                    <span class="hidden sm:inline">Reprocesos</span>
                </button>
                
                <button @click="activeTab = 'mezclas'" 
                        :class="activeTab === 'mezclas' ? 'bg-indigo-600 text-white active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="tab-button flex items-center gap-2">
                    <i class="fas fa-blender"></i>
                    <span class="hidden sm:inline">Mezclas</span>
                </button>
            </div>
        </div>
    </div>

    <!-- PROCESADOS TAB -->
    <div x-show="activeTab === 'procesados'" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         class="max-w-7xl mx-auto space-y-6">
        
        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Defectos Chart -->
            <div class="chart-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        <span>Defectos por Tipo</span>
                    </h3>
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        Últimos 30 días
                    </span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartDefectosProcesados"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="bg-red-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Total Defectos</p>
                        <p class="text-3xl font-bold text-red-600">{{ stats.defectos_procesados_total }}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Tasa de Defectos</p>
                        <p class="text-3xl font-bold text-green-600">{{ stats.tasa_defectos_procesados|floatformat:2 }}%</p>
                    </div>
                </div>
            </div>

            <!-- Rendimiento Chart -->
            <div class="chart-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-green-500"></i>
                        <span>Rendimiento por Trilla</span>
                    </h3>
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        Últimos 30 días
                    </span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartRendimientoProcesados"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-3 mt-6">
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Promedio</p>
                        <p class="text-2xl font-bold text-blue-600">{{ stats.rendimiento_promedio_procesados|floatformat:1 }}%</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Máximo</p>
                        <p class="text-2xl font-bold text-green-600">{{ stats.rendimiento_max_procesados|floatformat:1 }}%</p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Mínimo</p>
                        <p class="text-2xl font-bold text-amber-600">{{ stats.rendimiento_min_procesados|floatformat:1 }}%</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Tabla de Procesados -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-table"></i>
                    <span>Detalle de Procesados Recientes</span>
                </h3>
            </div>
            <div class="overflow-x-auto custom-scrollbar" style="max-height: 500px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Trilla</th>
                            <th>Fecha</th>
                            <th>Lote</th>
                            <th>Peso Inicial</th>
                            <th>Peso Final</th>
                            <th>Rendimiento</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for procesado in procesados %}
                        <tr>
                            <td>
                                <span class="font-bold text-gray-900">#{{ procesado.numero_trilla }}</span>
                            </td>
                            <td class="text-gray-600">{{ procesado.fecha|date:"d/m/Y" }}</td>
                            <td>
                                <span class="badge bg-blue-100 text-blue-800">
                                    {{ procesado.lote.codigo }}
                                </span>
                            </td>
                            <td class="font-semibold">{{ procesado.peso_inicial_kg|floatformat:2 }} kg</td>
                            <td class="font-semibold text-green-600">{{ procesado.peso_final_kg|floatformat:2 }} kg</td>
                            <td>
                                <span class="text-2xl font-bold {% if procesado.rendimiento >= 82 %}text-green-600{% elif procesado.rendimiento >= 75 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                    {{ procesado.rendimiento|floatformat:1 }}%
                                </span>
                            </td>
                            <td>
                                {% if procesado.rendimiento >= 82 %}
                                <span class="badge bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle"></i> Excelente
                                </span>
                                {% elif procesado.rendimiento >= 75 %}
                                <span class="badge bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-exclamation-circle"></i> Bueno
                                </span>
                                {% else %}
                                <span class="badge bg-red-100 text-red-800">
                                    <i class="fas fa-times-circle"></i> Revisar
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-12">
                                <div class="flex flex-col items-center justify-center text-gray-400">
                                    <i class="fas fa-inbox text-6xl mb-4"></i>
                                    <p class="text-lg font-semibold">No hay procesados en este periodo</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- REPROCESOS TAB -->
    <div x-show="activeTab === 'reprocesos'" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         class="max-w-7xl mx-auto space-y-6">
        
        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Defectos Chart -->
            <div class="chart-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        <span>Defectos en Reprocesos</span>
                    </h3>
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        Últimos 30 días
                    </span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartDefectosReprocesos"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="bg-red-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Total Defectos</p>
                        <p class="text-3xl font-bold text-red-600">{{ stats.defectos_reprocesos_total }}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Tasa de Defectos</p>
                        <p class="text-3xl font-bold text-green-600">{{ stats.tasa_defectos_reprocesos|floatformat:2 }}%</p>
                    </div>
                </div>
            </div>

            <!-- Rendimiento Chart -->
            <div class="chart-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-purple-500"></i>
                        <span>Rendimiento Reprocesos</span>
                    </h3>
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        Últimos 30 días
                    </span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartRendimientoReprocesos"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-3 mt-6">
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Promedio</p>
                        <p class="text-2xl font-bold text-blue-600">{{ stats.rendimiento_promedio_reprocesos|floatformat:1 }}%</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Máximo</p>
                        <p class="text-2xl font-bold text-green-600">{{ stats.rendimiento_max_reprocesos|floatformat:1 }}%</p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Mínimo</p>
                        <p class="text-2xl font-bold text-amber-600">{{ stats.rendimiento_min_reprocesos|floatformat:1 }}%</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Tabla de Reprocesos -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-table"></i>
                    <span>Detalle de Reprocesos Recientes</span>
                </h3>
            </div>
            <div class="overflow-x-auto custom-scrollbar" style="max-height: 500px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Reproceso</th>
                            <th>Fecha</th>
                            <th>Origen</th>
                            <th>Peso Inicial</th>
                            <th>Peso Final</th>
                            <th>Rendimiento</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reproceso in reprocesos %}
                        <tr>
                            <td>
                                <span class="font-bold text-gray-900">#{{ reproceso.numero }}</span>
                            </td>
                            <td class="text-gray-600">{{ reproceso.fecha|date:"d/m/Y" }}</td>
                            <td>
                                <span class="badge bg-purple-100 text-purple-800">
                                    Trilla #{{ reproceso.procesado.numero_trilla }}
                                </span>
                            </td>
                            <td class="font-semibold">{{ reproceso.peso_inicial_kg|floatformat:2 }} kg</td>
                            <td class="font-semibold text-purple-600">{{ reproceso.peso_final_kg|floatformat:2 }} kg</td>
                            <td>
                                <span class="text-2xl font-bold {% if reproceso.rendimiento >= 82 %}text-green-600{% elif reproceso.rendimiento >= 75 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                    {{ reproceso.rendimiento|floatformat:1 }}%
                                </span>
                            </td>
                            <td>
                                {% if reproceso.rendimiento >= 82 %}
                                <span class="badge bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle"></i> Excelente
                                </span>
                                {% elif reproceso.rendimiento >= 75 %}
                                <span class="badge bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-exclamation-circle"></i> Bueno
                                </span>
                                {% else %}
                                <span class="badge bg-red-100 text-red-800">
                                    <i class="fas fa-times-circle"></i> Revisar
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-12">
                                <div class="flex flex-col items-center justify-center text-gray-400">
                                    <i class="fas fa-inbox text-6xl mb-4"></i>
                                    <p class="text-lg font-semibold">No hay reprocesos en este periodo</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- MEZCLAS TAB -->
    <div x-show="activeTab === 'mezclas'" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         class="max-w-7xl mx-auto space-y-6">
        
        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Distribución Chart -->
            <div class="chart-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-chart-pie text-indigo-500"></i>
                        <span>Distribución por Destino</span>
                    </h3>
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        Últimos 30 días
                    </span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartDistribucionMezclas"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="bg-indigo-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Total Mezclas</p>
                        <p class="text-3xl font-bold text-indigo-600">{{ stats.total_mezclas_count }}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Peso Promedio</p>
                        <p class="text-3xl font-bold text-green-600">{{ stats.peso_promedio_mezclas|floatformat:0 }} kg</p>
                    </div>
                </div>
            </div>

            <!-- Calidad Chart -->
            <div class="chart-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-star text-amber-500"></i>
                        <span>Calidad de Mezclas</span>
                    </h3>
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        Últimos 30 días
                    </span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartCalidadMezclas"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-3 mt-6">
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Premium</p>
                        <p class="text-2xl font-bold text-green-600">{{ stats.mezclas_premium }}</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Estándar</p>
                        <p class="text-2xl font-bold text-blue-600">{{ stats.mezclas_estandar }}</p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1 font-semibold">Comercial</p>
                        <p class="text-2xl font-bold text-amber-600">{{ stats.mezclas_comercial }}</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Tabla de Mezclas -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 px-6 py-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-table"></i>
                    <span>Detalle de Mezclas Recientes</span>
                </h3>
            </div>
            <div class="overflow-x-auto custom-scrollbar" style="max-height: 500px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Mezcla</th>
                            <th>Fecha</th>
                            <th>Destino</th>
                            <th>Lotes</th>
                            <th>Peso Total</th>
                            <th>Calidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mezcla in mezclas %}
                        <tr>
                            <td>
                                <span class="font-bold text-gray-900">#{{ mezcla.numero }}</span>
                            </td>
                            <td class="text-gray-600">{{ mezcla.fecha|date:"d/m/Y" }}</td>
                            <td class="text-gray-900">{{ mezcla.destino|truncatewords:5 }}</td>
                            <td>
                                <span class="badge bg-indigo-100 text-indigo-800">
                                    {{ mezcla.detalles.count }} lotes
                                </span>
                            </td>
                            <td class="font-semibold text-indigo-600">{{ mezcla.peso_total_kg|floatformat:2 }} kg</td>
                            <td>
                                {% if mezcla.calidad_promedio >= 85 %}
                                <span class="badge bg-green-100 text-green-800">
                                    <i class="fas fa-star"></i> Premium
                                </span>
                                {% elif mezcla.calidad_promedio >= 80 %}
                                <span class="badge bg-blue-100 text-blue-800">
                                    <i class="fas fa-certificate"></i> Estándar
                                </span>
                                {% else %}
                                <span class="badge bg-amber-100 text-amber-800">
                                    <i class="fas fa-coffee"></i> Comercial
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'detalle_mezcla' mezcla.id %}" 
                                   class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all font-medium text-sm">
                                    <i class="fas fa-eye"></i>
                                    <span>Ver</span>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-12">
                                <div class="flex flex-col items-center justify-center text-gray-400">
                                    <i class="fas fa-inbox text-6xl mb-4"></i>
                                    <p class="text-lg font-semibold">No hay mezclas en este periodo</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Alpine.js Component -->
<script>
function dashboardBeneficio() {
    return {
        activeTab: 'procesados',
        periodoActual: 'Diciembre 2025',
        charts: {},
        
        init() {
            this.$nextTick(() => {
                this.initCharts();
            });
        },
        
        initCharts() {
            // Configuración común
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    }
                }
            };

            // Chart: Defectos Procesados
            const ctxDefectosProcesados = document.getElementById('chartDefectosProcesados');
            if (ctxDefectosProcesados) {
                this.charts.defectosProcesados = new Chart(ctxDefectosProcesados, {
                    type: 'doughnut',
                    data: {
                        labels: ['Broca', 'Vano', 'Quebrado', 'Mordido', 'Otros'],
                        datasets: [{
                            data: {{ defectos_procesados_data|safe }},
                            backgroundColor: [
                                '#EF4444',
                                '#F59E0B',
                                '#3B82F6',
                                '#8B5CF6',
                                '#6B7280'
                            ],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        ...commonOptions,
                        cutout: '60%'
                    }
                });
            }

            // Chart: Rendimiento Procesados
            const ctxRendimientoProcesados = document.getElementById('chartRendimientoProcesados');
            if (ctxRendimientoProcesados) {
                this.charts.rendimientoProcesados = new Chart(ctxRendimientoProcesados, {
                    type: 'bar',
                    data: {
                        labels: {{ rendimiento_procesados_labels|safe }},
                        datasets: [{
                            label: 'Rendimiento (%)',
                            data: {{ rendimiento_procesados_data|safe }},
                            backgroundColor: function(context) {
                                const value = context.parsed.y;
                                if (value >= 82) return '#10B981';
                                if (value >= 75) return '#F59E0B';
                                return '#EF4444';
                            },
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: '#f3f4f6'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Chart: Defectos Reprocesos
            const ctxDefectosReprocesos = document.getElementById('chartDefectosReprocesos');
            if (ctxDefectosReprocesos) {
                this.charts.defectosReprocesos = new Chart(ctxDefectosReprocesos, {
                    type: 'doughnut',
                    data: {
                        labels: ['Broca', 'Vano', 'Quebrado', 'Mordido', 'Otros'],
                        datasets: [{
                            data: {{ defectos_reprocesos_data|safe }},
                            backgroundColor: [
                                '#A855F7',
                                '#EC4899',
                                '#F59E0B',
                                '#3B82F6',
                                '#6B7280'
                            ],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        ...commonOptions,
                        cutout: '60%'
                    }
                });
            }

            // Chart: Rendimiento Reprocesos
            const ctxRendimientoReprocesos = document.getElementById('chartRendimientoReprocesos');
            if (ctxRendimientoReprocesos) {
                this.charts.rendimientoReprocesos = new Chart(ctxRendimientoReprocesos, {
                    type: 'bar',
                    data: {
                        labels: {{ rendimiento_reprocesos_labels|safe }},
                        datasets: [{
                            label: 'Rendimiento (%)',
                            data: {{ rendimiento_reprocesos_data|safe }},
                            backgroundColor: '#A855F7',
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: '#f3f4f6'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Chart: Distribución Mezclas
            const ctxDistribucionMezclas = document.getElementById('chartDistribucionMezclas');
            if (ctxDistribucionMezclas) {
                this.charts.distribucionMezclas = new Chart(ctxDistribucionMezclas, {
                    type: 'pie',
                    data: {
                        labels: {{ distribucion_mezclas_labels|safe }},
                        datasets: [{
                            data: {{ distribucion_mezclas_data|safe }},
                            backgroundColor: [
                                '#6366F1',
                                '#8B5CF6',
                                '#A855F7',
                                '#EC4899',
                                '#F59E0B'
                            ],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: commonOptions
                });
            }

            // Chart: Calidad Mezclas
            const ctxCalidadMezclas = document.getElementById('chartCalidadMezclas');
            if (ctxCalidadMezclas) {
                this.charts.calidadMezclas = new Chart(ctxCalidadMezclas, {
                    type: 'bar',
                    data: {
                        labels: ['Premium', 'Estándar', 'Comercial'],
                        datasets: [{
                            label: 'Cantidad',
                            data: [
                                {{ stats.mezclas_premium }},
                                {{ stats.mezclas_estandar }},
                                {{ stats.mezclas_comercial }}
                            ],
                            backgroundColor: ['#10B981', '#3B82F6', '#F59E0B'],
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f3f4f6'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        },
        
        exportarReporte() {
            alert('Funcionalidad de exportación a PDF en desarrollo');
        },
        
        imprimirReporte() {
            window.print();
        }
    }
}
</script>

<style>
@media print {
    .no-print, button, .hero-gradient {
        display: none !important;
    }
    
    .chart-card {
        page-break-inside: avoid;
    }
}
</style>

{% endblock %}