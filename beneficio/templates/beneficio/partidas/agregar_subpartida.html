{% extends 'base.html' %}

{% block title %}Agregar Lote de Punto{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50 py-8">
    <div class="max-w-6xl mx-auto px-4">

        <!-- Encabezado -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-green-100 rounded-full -mr-32 -mt-32 opacity-50"></div>
            <div class="relative">
                <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                    <i class="fas fa-plus-circle text-green-600"></i>
                    Agregar Lote de Punto
                </h1>
                <p class="mt-2 text-gray-600">
                    Partida:
                    <strong class="text-green-700">{{ partida.numero_partida }} - {{ partida.nombre }}</strong>
                </p>

                {% if partida.bodega or partida.percha %}
                <div class="mt-3 flex items-center gap-2 text-sm text-blue-700 bg-blue-50 px-3 py-2 rounded-lg inline-block">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>
                        {% if partida.bodega %}{{ partida.bodega.nombre }}{% endif %}
                        {% if partida.percha %} - {{ partida.percha }}{% endif %}
                    </span>
                </div>
                {% endif %}
            </div>

            <div class="absolute top-4 right-4 bg-green-100 px-4 py-2 rounded-lg">
                <p class="text-sm text-green-800 font-semibold">PESO ACTUAL</p>
                <p class="text-2xl font-bold text-green-700">{{ partida.peso_total_kg|floatformat:2 }} kg</p>
            </div>
        </div>

        <form method="post" class="bg-white rounded-xl shadow-lg p-8 space-y-8">
            {% csrf_token %}

            <!-- Información Básica del Lote -->
            <div class="border-l-4 border-green-500 bg-green-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <i class="fas fa-coffee text-green-600"></i>
                    Información del Lote
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- ID del Lote (nombre) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag text-green-600 mr-1"></i>
                            ID del Lote <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               name="nombre"
                               required
                               placeholder="Ej: DELFINA / NANDO 3RAS, WILSON 3RAS"
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-green-600 font-semibold">
                    </div>

                    <!-- Fecha -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar text-green-600 mr-1"></i>
                            Fecha
                        </label>
                        <input type="date"
                               name="fecha_ingreso"
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-green-600">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <!-- Tipo de Proceso -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-cogs text-green-600 mr-1"></i>
                            Tipo de Proceso <span class="text-red-500">*</span>
                        </label>
                        <select name="tipo_proceso"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-green-600 font-semibold">
                            <option value="LAVADO">Lavado</option>
                            <option value="NATURAL">Natural</option>
                            <option value="HONEY">Honey</option>
                            <option value="LADADO">Ladado</option>
                            <option value="LAVADO 2 LATAS">Lavado 2 Latas</option>
                        </select>
                    </div>

                    <!-- Número de Sacos -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-box text-green-600 mr-1"></i>
                            Sacos <span class="text-red-500">*</span>
                        </label>
                        <input type="number"
                               name="numero_sacos"
                               value="1"
                               min="1"
                               required
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-green-600 font-semibold">
                    </div>

                    <!-- Quintales -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-weight text-green-600 mr-1"></i>
                            Quintales (qq) <span class="text-red-500">*</span>
                        </label>
                        <input type="number"
                               name="quintales"
                               id="quintales"
                               step="0.01"
                               required
                               placeholder="0.00"
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-green-600 font-semibold">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <!-- Humedad -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tint text-blue-600 mr-1"></i>
                            Humedad (%)
                        </label>
                        <input type="number"
                               name="humedad"
                               step="0.1"
                               placeholder="Ej: 10.3"
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-blue-600">
                    </div>

                    <!-- Fila/Ubicación -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-layer-group text-blue-600 mr-1"></i>
                            Fila / Ubicación
                        </label>
                        <input type="text"
                               name="fila"
                               placeholder="Ej: Fila 1, Nivel A"
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-blue-600">
                    </div>

                    <!-- Etiqueta -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-bookmark text-blue-600 mr-1"></i>
                            Etiqueta
                        </label>
                        <input type="text"
                               name="etiqueta"
                               id="etiqueta-input"
                               list="etiquetas-list"
                               placeholder="Escriba o seleccione una etiqueta"
                               autocomplete="off"
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-blue-600">
                        <datalist id="etiquetas-list">
                            {% for etiqueta in etiquetas %}
                            <option value="{{ etiqueta.nombre }}">
                            {% endfor %}
                        </datalist>
                        <p class="text-xs text-gray-500 mt-1">Puede seleccionar una existente o escribir una nueva</p>
                    </div>
                </div>
            </div>

            <!-- Análisis de Calidad -->
            <div class="border-l-4 border-amber-500 bg-amber-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-amber-600"></i>
                    Análisis de Calidad
                </h2>

                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <!-- b/15 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">b/15</label>
                        <input type="number"
                               name="rendimiento_b15"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Defectos -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defectos %</label>
                        <input type="number"
                               name="defectos"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- RB -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">RB</label>
                        <input type="number"
                               name="rb"
                               step="0.0001"
                               placeholder="0.0000"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- RN -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">RN</label>
                        <input type="number"
                               name="rn"
                               step="0.0001"
                               placeholder="0.0000"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Score -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Punteo</label>
                        <input type="number"
                               name="score"
                               step="0.01"
                               min="0"
                               max="100"
                               placeholder="84.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>

                <!-- Segunda fila de análisis -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <!-- Peso C/P -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Peso C/P</label>
                        <input type="number"
                               name="peso_cp"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Oro Sucio -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Oro Sucio</label>
                        <input type="number"
                               name="oro_sucio"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Oro Limpio -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Oro Limpio</label>
                        <input type="number"
                               name="oro_limpio"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Granulometría -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Granulometría</label>
                        <input type="text"
                               name="granulometria"
                               placeholder="Ej: 15-18"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>

                <!-- Tercera fila: B/Z y Defectos -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <!-- B/Z Gramos -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">B/Z (gramos)</label>
                        <input type="number"
                               name="bz_gramos"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- B/Z Porcentaje -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">B/Z (%)</label>
                        <input type="number"
                               name="bz_porcentaje"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Defectos Físicos -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defectos Físicos %</label>
                        <input type="number"
                               name="defectos_fisicos"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Defectos Verdes -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defectos Verdes %</label>
                        <input type="number"
                               name="defectos_verdes"
                               step="0.01"
                               placeholder="0.00"
                               class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
            </div>

            <!-- Calidad de Taza y Cualidades -->
            <div class="border-l-4 border-purple-500 bg-purple-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <i class="fas fa-mug-hot text-purple-600"></i>
                    Calidad de Taza
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Taza -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-certificate text-purple-600 mr-1"></i>
                            Calidad de Taza
                        </label>
                        <select name="taza"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-purple-600">
                            <option value="">-- Seleccionar --</option>
                            <option value="SANA LIMPIA">Sana Limpia</option>
                            <option value="LIMPIA">Limpia</option>
                            <option value="REGULAR">Regular</option>
                            <option value="DEFECTUOSA">Defectuosa</option>
                        </select>
                    </div>

                    <!-- Proveedor -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user text-purple-600 mr-1"></i>
                            Proveedor
                        </label>
                        <input type="text"
                               name="proveedor"
                               placeholder="Nombre del proveedor"
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-purple-600">
                    </div>
                </div>

                <!-- Cualidades -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-star text-purple-600 mr-1"></i>
                        Cualidades (sabores, aromas)
                    </label>
                    <textarea name="cualidades"
                              rows="2"
                              placeholder="Ej: CARAMELO, CHOCOLATE, CITRICO, NARANJA, NUEZ, FRUTOS ROJOS, MIEL, FLORAL"
                              class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-purple-600"></textarea>
                </div>

                <!-- Perfil Sensorial -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-wine-glass-alt text-purple-600 mr-1"></i>
                        Perfil Sensorial
                    </label>
                    <textarea name="perfil_sensorial"
                              rows="2"
                              placeholder="Descripción del perfil sensorial del café..."
                              class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-purple-600"></textarea>
                </div>
            </div>

            <!-- Pesos (oculto, se calcula automáticamente desde quintales) -->
            <input type="hidden" name="peso_bruto" id="peso_bruto" value="0">
            <input type="hidden" name="tara" value="0">
            <input type="hidden" name="unidad_medida" value="qq">

            <!-- Observaciones -->
            <div class="bg-gray-50 p-6 rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-sticky-note text-gray-600 mr-1"></i>
                    Observaciones
                </label>
                <textarea name="observaciones"
                          rows="2"
                          placeholder="Notas adicionales..."
                          class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:ring-2 focus:ring-gray-500"></textarea>
            </div>

            <!-- Botones -->
            <div class="flex gap-3 pt-6 border-t">
                <a href="{% url 'detalle_partida' partida.pk %}"
                   class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 text-center font-medium">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </a>
                <button type="submit"
                        class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    <i class="fas fa-plus mr-2"></i>Agregar Lote
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cuando cambian los quintales, actualizar el peso bruto (1 qq = 46 kg)
    const quintalesInput = document.getElementById('quintales');
    const pesoBrutoInput = document.getElementById('peso_bruto');

    quintalesInput.addEventListener('input', function() {
        const qq = parseFloat(this.value) || 0;
        const kg = qq * 46; // 1 quintal = 46 kg
        pesoBrutoInput.value = kg.toFixed(2);
    });
});
</script>
{% endblock %}
