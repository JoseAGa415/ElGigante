{% extends 'base.html' %}
{% load static %}

{% block title %}Re-reprocesar Reproceso #{{ reproceso_origen.numero }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Encabezado -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl shadow-lg p-6 mb-8 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-3">
                <i class="fas fa-sync"></i>
                Crear Nuevo Reproceso desde Reproceso #{{ reproceso_origen.numero }}
            </h1>
            <p class="mt-2 text-green-50">
                Re-reprocesando material del reproceso anterior
            </p>
        </div>

        <!-- Información del Origen -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-600"></i>
                Origen del Re-reproceso
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-xs text-blue-600 uppercase font-semibold mb-1">Trilla</p>
                    <p class="text-lg font-bold text-gray-900">#{{ reproceso_origen.procesado.numero_trilla }}</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-xs text-purple-600 uppercase font-semibold mb-1">Lote</p>
                    <p class="text-lg font-bold text-gray-900">{{ reproceso_origen.procesado.lote.codigo }}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-xs text-green-600 uppercase font-semibold mb-1">Reproceso Anterior</p>
                    <p class="text-lg font-bold text-gray-900">#{{ reproceso_origen.numero }}</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <p class="text-xs text-yellow-600 uppercase font-semibold mb-1">Peso Final Anterior</p>
                    <p class="text-lg font-bold text-gray-900">{{ reproceso_origen.peso_final_kg }} kg</p>
                </div>
            </div>
        </div>

        <!-- Formulario -->
        <form method="post" class="bg-white rounded-xl shadow-lg p-8 space-y-8">
            {% csrf_token %}

            <!-- Nombre del Reproceso -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-tag text-gray-600 mr-2"></i>
                    Nombre del Nuevo Reproceso
                </label>
                <input type="text" 
                       name="nombre" 
                       value="Re-reproceso de #{{ reproceso_origen.numero }}"
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-600">
                <p class="text-xs text-gray-500 mt-1">Nombre identificador para este reproceso</p>
            </div>

            <!-- SECCIÓN: HORARIO DEL PROCESO -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-2 border-blue-300">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-clock text-blue-600"></i>
                    Horario del Proceso
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Hora de Inicio <span class="text-red-500">*</span>
                        </label>
                        <input type="time" 
                               name="hora_inicio"
                               required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600">
                        <p class="text-xs text-gray-500 mt-1">Hora en que inició el re-procesamiento</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Hora Final <span class="text-red-500">*</span>
                        </label>
                        <input type="time" 
                               name="hora_fin"
                               required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600">
                        <p class="text-xs text-gray-500 mt-1">Hora en que finalizó el re-procesamiento</p>
                    </div>
                </div>
            </div>

                     <!-- SECCIÓN: BODEGA DE ALMACENAMIENTO -->
            <div class="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-warehouse text-amber-600"></i>
                    Bodega de Almacenamiento
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ¿En qué bodega quedó el café? <span class="text-red-500">*</span>
                        </label>
                        <select name="bodega_destino" 
                                required
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-amber-600">
                            <option value="">Seleccione bodega...</option>
                            {% for bodega in bodegas %}
                            <option value="{{ bodega.id }}" {% if bodega.id == lote.bodega.id %}selected{% endif %}>
                                {{ bodega.get_codigo_display }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-xs text-blue-600 font-semibold mb-1">BODEGA ORIGINAL</p>
                        <p class="text-xl font-bold text-gray-900">Bodega {{ lote.bodega.codigo }}</p>
                    </div>
                </div>
            </div>   

            <!-- SECCIÓN: ENCARGADO DEL REPROCESO -->
            <div class="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-user text-amber-600"></i>
                    Encargado del Reproceso
                </h2>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Persona a cargo en piso
                    </label>
                    <input type="text" 
                           name="encargado_reproceso"
                           placeholder="Nombre del encargado"
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-amber-600">
                    <p class="text-xs text-gray-500 mt-1">Persona responsable de este reproceso</p>
                </div>
            </div>

            <!-- SECCIÓN: PESOS DEL REPROCESO -->
            <div class="border-l-4 border-green-500 bg-green-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-balance-scale text-green-600"></i>
                    Pesos del Reproceso
                </h2>
                
                <!-- Peso Inicial -->
                <div class="mb-6">
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-arrow-right text-green-600 mr-2"></i>
                        Peso Inicial <span class="text-red-500 ml-1">*</span>
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   id="operacion-inicial"
                                   placeholder="13*1.52+0.58"
                                   oninput="calcularOperacion('inicial')"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado (kg)</label>
                            <input type="number" 
                                   step="0.01" 
                                   name="peso_inicial_kg" 
                                   id="peso-inicial" 
                                   required
                                   value="{{ reproceso_origen.peso_final_kg }}"
                                   onchange="calcularRendimiento()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600 text-center font-bold text-lg">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_peso_inicial" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600 bg-white text-center font-medium">
                                <option value="kg">kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">libras</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-xs text-green-600 mt-2 font-semibold">
                        <i class="fas fa-info-circle mr-1"></i>
                        Peso final del reproceso anterior: {{ reproceso_origen.peso_final_kg }} kg
                    </p>
                </div>

                <!-- Peso Final -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-arrow-left text-blue-600 mr-2"></i>
                        Peso Final <span class="text-red-500 ml-1">*</span>
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   id="operacion-final"
                                   placeholder="10*1.52+0.30"
                                   oninput="calcularOperacion('final')"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado (kg)</label>
                            <input type="number" 
                                   step="0.01" 
                                   name="peso_final_kg" 
                                   id="peso-final" 
                                   required
                                   onchange="calcularRendimiento()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 text-center font-bold text-lg">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_peso_final" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 bg-white text-center font-medium">
                                <option value="kg">kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">libras</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Indicador de Rendimiento -->
                <div id="rendimiento-display" class="hidden mt-6 p-4 rounded-lg border-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium flex items-center">
                            <i class="fas fa-percentage mr-2"></i>
                            Rendimiento Calculado:
                        </span>
                        <span class="text-3xl font-bold" id="rendimiento-valor">0.00%</span>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: CLASIFICACIÓN DEL CAFÉ -->
            <div class="border-l-4 border-amber-500 bg-amber-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-star text-amber-600"></i>
                    Clasificación de Café
                </h2>
                
                <!-- Café Primera -->
                <div class="mb-6">
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-medal text-yellow-500 mr-2"></i>
                        Café de Primera
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   id="operacion-primera"
                                   placeholder="8*1.52"
                                   oninput="calcularOperacion('primera')"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado (kg)</label>
                            <input type="number" 
                                   step="0.01" 
                                   name="cafe_primera" 
                                   id="cafe-primera"
                                   value="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 text-center font-bold text-lg">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_cafe_primera" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 bg-white text-center font-medium">
                                <option value="kg">kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">libras</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Café Segunda -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-medal text-gray-400 mr-2"></i>
                        Café de Segunda
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Operación</label>
                            <input type="text" 
                                   id="operacion-segunda"
                                   placeholder="2*1.52"
                                   oninput="calcularOperacion('segunda')"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Resultado (kg)</label>
                            <input type="number" 
                                   step="0.01" 
                                   name="cafe_segunda" 
                                   id="cafe-segunda"
                                   value="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 text-center font-bold text-lg">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Unidad</label>
                            <select name="unidad_cafe_segunda" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 bg-white text-center font-medium">
                                <option value="kg">kg</option>
                                <option value="qq">qq</option>
                                <option value="lb">libras</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: MERMAS Y RECHAZOS -->
            <div class="border-l-4 border-red-500 bg-red-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                    Mermas del Reproceso
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-filter text-amber-500 mr-1"></i>
                            Catadura (kg)
                        </label>
                        <input type="number" step="0.01" name="catadura" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-times-circle text-red-500 mr-1"></i>
                            Rechazo Electrónica (kg)
                        </label>
                        <input type="number" step="0.01" name="rechazo_electronica" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-arrow-down text-blue-500 mr-1"></i>
                            Bajo Zaranda (kg)
                        </label>
                        <input type="number" step="0.01" name="bajo_zaranda" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-broom text-green-500 mr-1"></i>
                            Barridos (kg)
                        </label>
                        <input type="number" step="0.01" name="barridos" value="0" placeholder="0.00"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-600">
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: MOTIVO -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-comment-alt text-gray-600 mr-2"></i>
                    Motivo del Re-reproceso <span class="text-red-500">*</span>
                </label>
                <textarea name="motivo" 
                          rows="4"
                          required
                          placeholder="Describe por qué es necesario volver a reprocesar este material..."
                          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600"></textarea>
            </div>

            <!-- Botones -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <a href="{% url 'lista_reprocesos' %}" 
                   class="px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">
                    <i class="fas fa-times mr-2"></i>
                    Cancelar
                </a>
                <button type="submit" 
                        class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition font-medium shadow-lg hover:shadow-xl">
                    <i class="fas fa-sync mr-2"></i>
                    Crear Reproceso
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Función para calcular operaciones matemáticas
function calcularOperacion(tipo) {
    const operacionInput = document.getElementById('operacion-' + tipo);
    const resultadoInput = document.getElementById(tipo === 'inicial' ? 'peso-inicial' : 
                                                   tipo === 'final' ? 'peso-final' : 
                                                   tipo === 'primera' ? 'cafe-primera' :
                                                   tipo === 'segunda' ? 'cafe-segunda' : tipo);
    
    try {
        const operacion = operacionInput.value.replace(',', '.');
        
        if (/^[0-9+\-*/().\s]*$/.test(operacion) && operacion.trim() !== "") {
            const resultado = eval(operacion);
        
            if (!isNaN(resultado) && isFinite(resultado)) {
                resultadoInput.value = resultado.toFixed(2);
                
                if (tipo === 'inicial' || tipo === 'final') {
                    calcularRendimiento();
                }
            }
        }
    } catch (e) {
        // Si hay error, no hacer nada
    }
}

function calcularRendimiento() {
    const pesoInicial = parseFloat(document.getElementById('peso-inicial').value) || 0;
    const pesoFinal = parseFloat(document.getElementById('peso-final').value) || 0;
    
    const display = document.getElementById('rendimiento-display');
    const valor = document.getElementById('rendimiento-valor');

    if (pesoInicial > 0 && pesoFinal > 0) {
        const rendimiento = (pesoFinal / pesoInicial * 100);
        valor.textContent = rendimiento.toFixed(2) + '%';
        display.classList.remove('hidden');
        
        if (rendimiento >= 80) {
            display.className = 'mt-6 p-4 rounded-lg border-2 bg-green-50 border-green-300';
            valor.className = 'text-3xl font-bold text-green-700';
        } else if (rendimiento >= 70) {
            display.className = 'mt-6 p-4 rounded-lg border-2 bg-yellow-50 border-yellow-300';
            valor.className = 'text-3xl font-bold text-yellow-700';
        } else {
            display.className = 'mt-6 p-4 rounded-lg border-2 bg-red-50 border-red-300';
            valor.className = 'text-3xl font-bold text-red-700';
        }
    } else {
        valor.textContent = '0.00%';
        display.className = 'hidden mt-6 p-4 rounded-lg border-2 bg-gray-50 border-gray-300';
        valor.className = 'text-3xl font-bold text-gray-700';
    }
}

// Auto-completar hora actual
window.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const horaActual = now.toTimeString().slice(0, 5);
    
    const inputHoraInicio = document.querySelector('input[name="hora_inicio"]');
    if (inputHoraInicio && !inputHoraInicio.value) {
        inputHoraInicio.value = horaActual;
    }
    
    // Calcular rendimiento inicial
    calcularRendimiento();
});
</script>
{% endblock %}